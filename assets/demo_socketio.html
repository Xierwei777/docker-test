<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å§¿æ€åˆ†æ - Socket.IO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch; /* æ‹‰ä¼¸å¡«æ»¡å®½åº¦ */
            padding: 0; /* ç§»é™¤è¾¹è· */
            margin: 0;
        }

        .container {
            background: white;
            padding: 20px 0; /* ä¸Šä¸‹20pxï¼Œå·¦å³0px - å¡«æ»¡å®½åº¦ */
            max-width: 100%; /* å¡«æ»¡æ•´ä¸ªå±å¹•å®½åº¦ */
            width: 100%;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px; /* æ·»åŠ å·¦å³å†…è¾¹è· */
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            flex: 1;
            min-width: 300px;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin: 5px 0 0 0;
            font-size: 1em;
        }

        .status-bar {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            animation: pulse 2s infinite;
            border: 2px solid white;
        }

        .status-dot.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        .status-dot.streaming {
            background: #FFD700;
            box-shadow: 0 0 10px #FFD700;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä¸»å¸ƒå±€ï¼šä¸Šä¸‹åˆ†æ  */
        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
            padding: 0 20px; /* æ·»åŠ å·¦å³å†…è¾¹è· */
        }

        /* ä¸Šæ–¹ï¼šè§†é¢‘æµåŒºåŸŸ */
        .video-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ä¸‹æ–¹ï¼šæ•°æ®å±•ç¤ºåŒºåŸŸ */
        .data-section {
            display: flex;
            flex-direction: column;
        }

        /* è§†é¢‘å®¹å™¨ï¼šä¸¤ä¸ªè§†é¢‘æ¨ªå‘æ’åˆ— */
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* å“åº”å¼ï¼šçª„å±æ—¶è§†é¢‘ç«–æ’ */
        @media (max-width: 1200px) {
            .video-container {
                grid-template-columns: 1fr; /* çª„å±æ—¶è§†é¢‘ç«–æ’ */
            }

            .video-box {
                min-height: 300px; /* çª„å±æ—¶è°ƒæ•´æœ€å°é«˜åº¦ */
            }

            .log-monitor {
                max-height: 600px; /* çª„å±æ—¶é™ä½é«˜åº¦ */
            }

            .log-output {
                min-height: 300px;
                max-height: 450px;
            }
        }

        /* å“åº”å¼ï¼šçª„å±æ—¶å¤´éƒ¨å‚ç›´å¸ƒå±€ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 0 15px; /* ç§»åŠ¨ç«¯ç¨å°çš„å†…è¾¹è· */
            }

            .main-layout {
                padding: 0 15px; /* ç§»åŠ¨ç«¯ç¨å°çš„å†…è¾¹è· */
            }

            .header-left {
                width: 100%;
                min-width: auto;
            }

            .status-bar {
                width: 100%;
            }

            .video-box {
                min-height: 250px; /* ç§»åŠ¨ç«¯è°ƒæ•´æœ€å°é«˜åº¦ */
            }

            .log-monitor {
                max-height: 500px; /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥é™ä½é«˜åº¦ */
            }

            .log-output {
                min-height: 250px;
                max-height: 350px;
            }
        }

        .video-box {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 4/3;
            min-height: 350px; /* æœ€å°é«˜åº¦ï¼Œä¸Šä¸‹å¸ƒå±€æ—¶ç¨å°ä¸€äº› */
        }

        .video-box video,
        .video-box img,
        .video-box canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* éšè—ç©º img çš„ç ´æŸå›¾æ ‡ */
        .video-box img[src=""],
        .video-box img:not([src]) {
            opacity: 0;
        }

        /* ä¸ºç©ºè§†é¢‘æ·»åŠ å ä½ç¬¦ */
        .video-box.waiting {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
        }

        .video-box.waiting::before {
            content: 'â³ ç­‰å¾…è§†é¢‘æµ...';
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            position: absolute;
            z-index: 1;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }



        /* æ‰“å°å°é£æ ¼æ—¥å¿—è¾“å‡º */
        .log-monitor {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            max-height: 800px; /* å›ºå®šæœ€å¤§é«˜åº¦ï¼Œé¿å…æ’‘é•¿é¡µé¢ */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .log-monitor.active {
            display: flex;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .log-title {
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
            font-family: 'Courier New', monospace;
        }

        .log-controls {
            display: flex;
            gap: 10px;
        }

        .log-btn {
            padding: 5px 15px;
            font-size: 0.85em;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #667eea;
            background: transparent;
            color: #667eea;
            transition: all 0.3s;
        }

        .log-btn:hover {
            background: #667eea;
            color: #ffffff;
        }

        .log-output {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            flex: 1 1 auto;
            overflow-y: auto; /* å†…ç½®æ»šåŠ¨æ¡ */
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.5;
            color: #333;
            border: 1px solid #e0e0e0;
            min-height: 400px; /* æœ€å°é«˜åº¦ */
            max-height: 650px; /* æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿æœ‰æ»šåŠ¨æ¡ */
        }

        .log-output::-webkit-scrollbar {
            width: 8px;
        }

        .log-output::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        .log-output::-webkit-scrollbar-thumb {
            background: #999;
            border-radius: 4px;
        }
        
        .log-output::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .log-line {
            padding: 2px 0;
            white-space: nowrap;
            overflow-x: auto;
        }

        .log-line.header {
            color: #667eea;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .log-line.separator {
            color: #ccc;
            margin: 5px 0;
        }

        .log-number {
            color: #2196F3;
        }

        .log-time {
            color: #FF9800;
        }

        .log-status-detect {
            color: #4CAF50;
            font-weight: bold;
        }

        .log-status-notarget {
            color: #f44336;
            font-weight: bold;
        }

        .log-pose {
            color: #9C27B0;
            font-weight: bold;
        }

        .log-conf {
            color: #00BCD4;
        }

        .log-points {
            color: #8BC34A;
        }

        /* æ ¼å¼è¯´æ˜é¢æ¿ */
        .format-guide {
            margin-top: 15px;
            margin-bottom: 10px;
            background: #fafafa;
            border-radius: 5px;
            padding: 15px;
            display: none;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }

        .format-guide.active {
            display: block;
        }

        .format-guide h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .format-guide table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .format-guide th,
        .format-guide td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            color: #666;
        }

        .format-guide th {
            color: #667eea;
            font-weight: bold;
            background: #f5f5f5;
        }

        .format-guide code {
            background: #e8eaf6;
            padding: 2px 6px;
            border-radius: 3px;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .badge-new {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ï¼šæ ‡é¢˜ä¸çŠ¶æ€æ  -->
        <div class="header">
            <div class="header-left">
        <h1>ğŸƒ å®æ—¶å§¿æ€åˆ†æç³»ç»Ÿ</h1>
        <p class="subtitle">åŸºäº MediaPipe å’Œ Flask-SocketIO</p>
            </div>
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionStatus"></div>
                    <span id="statusText">æœåŠ¡å™¨æœªè¿æ¥</span>
            </div>
            </div>
        </div>

        <!-- ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  -->
        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šè§†é¢‘æµåŒºåŸŸ -->
            <div class="video-section">
        <div class="video-container">
            <div class="video-box">
                <div class="video-label">ğŸ“¹ æ‘„åƒå¤´</div>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
                    <div class="video-box waiting" id="processedVideoBox">
                <div class="video-label">ğŸ¯ å§¿æ€åˆ†æ</div>
                <img id="processedVideo" src="" alt="ç­‰å¾…è§†é¢‘æµ...">
            </div>
        </div>

        <div class="controls">
            <button class="btn-success" id="startBtn" onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
            <button class="btn-primary" id="streamBtn" onclick="startStream()" disabled>å¼€å§‹åˆ†æ</button>
            <button class="btn-danger" id="stopBtn" onclick="stopStream()" disabled>åœæ­¢åˆ†æ</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <div class="data-section">
                <!-- æ‰“å°å°é£æ ¼æ—¥å¿—ç›‘æ§ -->
                <div class="log-monitor active" id="logMonitor">
                    <div class="log-header">
                        <div class="log-title">
                            ğŸ“º MONITOR <span class="badge badge-new">NEW</span>
                        </div>
                        <div class="log-controls">
                            <button class="log-btn" onclick="toggleFormatGuide()">ğŸ“– æ ¼å¼</button>
                            <button class="log-btn" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©º</button>
                            <button class="log-btn" onclick="toggleAutoScroll()">
                                <span id="autoScrollText">ğŸ” ç½®é¡¶</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ ¼å¼è¯´æ˜ -->
                    <div class="format-guide" id="formatGuide">
                        <h4>ğŸ“‹ è¾“å‡ºæ ¼å¼è¯´æ˜</h4>
                        <p style="color: #FF9800; margin-bottom: 10px; font-size: 0.9em;">
                            ğŸ’¡ <strong>æç¤º</strong>: æœ€æ–°è®°å½•åœ¨é¡¶éƒ¨ï¼Œå‘ä¸‹æ»šåŠ¨æŸ¥çœ‹å†å²è®°å½•
                        </p>
                        <table>
                            <thead>
                                <tr>
                                    <th>å­—æ®µ</th>
                                    <th>è¯´æ˜</th>
                                    <th>ç¤ºä¾‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>#00001</code></td>
                                    <td>è®°å½•åºå·ï¼ˆ5ä½æ•°ï¼‰</td>
                                    <td>#00001, #00123</td>
                                </tr>
                                <tr>
                                    <td><code>æ—¶é—´æˆ³</code></td>
                                    <td>ç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´</td>
                                    <td>2025-11-04 14:30:15.234</td>
                                </tr>
                                <tr>
                                    <td><code>[ DETECT ]</code></td>
                                    <td>æ£€æµ‹åˆ°ç›®æ ‡</td>
                                    <td>ç»¿è‰²æ˜¾ç¤º</td>
                                </tr>
                                <tr>
                                    <td><code>[NO TARGET]</code></td>
                                    <td>æœªæ£€æµ‹åˆ°ç›®æ ‡</td>
                                    <td>çº¢è‰²æ˜¾ç¤º</td>
                                </tr>
                                <tr>
                                    <td><code>Pose</code></td>
                                    <td>å§¿æ€ç±»å‹</td>
                                    <td>STANDING, SIT, STOOP, LYING, KNEEL</td>
                                </tr>
                                <tr>
                                    <td><code>Conf</code></td>
                                    <td>ç½®ä¿¡åº¦ï¼ˆ0.00-1.00ï¼‰</td>
                                    <td>0.95</td>
                                </tr>
                                <tr>
                                    <td><code>Points</code></td>
                                    <td>æ£€æµ‹åˆ°çš„å…³é”®ç‚¹æ•°é‡</td>
                                    <td>33</td>
                                </tr>
                            </tbody>
                        </table>
        </div>

                    <div class="log-output" id="logOutput">
                        <div class="log-line header">
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        </div>
                        <div class="log-line header">
                            ğŸ“Š REAL-TIME LOG (Latest on Top â¬†ï¸ | Scroll Down for History â¬‡ï¸)
                        </div>
                        <div class="log-line header">
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket;
        let localStream;
        let isStreaming = false;
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let logRecordCount = 0;
        let autoScroll = true;
        let maxLogLines = 500; // æœ€å¤šä¿ç•™500æ¡è®°å½•
        
        // ğŸ”¥ ä¼˜åŒ–ï¼šæ€§èƒ½ç›¸å…³å˜é‡
        let canvasInitialized = false;  // Canvas æ˜¯å¦å·²åˆå§‹åŒ–
        let jpegQuality = 0.5;  // ğŸ”¥ 20 FPSæ¨¡å¼ï¼šé™ä½åˆå§‹JPEGè´¨é‡åˆ°0.5ï¼ˆè‡ªé€‚åº”0.4-0.6ï¼‰
        let frameInterval = 50;  // ğŸ”¥ è‡ªé€‚åº”å¸§ç‡ï¼šåˆå§‹50msï¼ˆ20 FPSï¼‰ï¼Œæ ¹æ®ç½‘ç»œè‡ªåŠ¨è°ƒæ•´
        let performanceStats = {
            encodeTime: 0,
            frameSize: 0,
            lastUpdateTime: Date.now()
        };

        // åˆå§‹åŒ– Socket.IO è¿æ¥
        function initSocket() {
            socket = io({
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                updateStatus('connected', 'æœåŠ¡å™¨å·²è¿æ¥');
            });

            socket.on('disconnect', () => {
                console.log('å·²æ–­å¼€è¿æ¥');
                updateStatus('disconnected', 'âŒ æœåŠ¡å™¨å·²æ–­å¼€');
                stopStream();
            });

            socket.on('server_response', (data) => {
                console.log('æœåŠ¡å™¨å“åº”:', data);
            });
            
            // ğŸ”¥ ä¼˜åŒ–ï¼šç½‘ç»œè´¨é‡è‡ªé€‚åº”ï¼ˆ20 FPSæ¨¡å¼ - æ›´æ¿€è¿›çš„å‹ç¼© + å¸§ç‡é™çº§ï¼‰
            socket.on('network_quality', (data) => {
                const skipRate = data.skip_rate;
                
                // ğŸ”¥ è‡ªé€‚åº”å¸§ç‡é™çº§æœºåˆ¶
                if (skipRate > 80) {
                    // ç½‘ç»œéå¸¸æ…¢ â†’ é™è‡³ 5 FPS
                    frameInterval = 200;
                    jpegQuality = 0.4;
                    console.log('ğŸ”´ [Auto-Throttle] Network critical â†’ 5 FPS, Quality 0.4');
                } else if (skipRate > 60) {
                    // ç½‘ç»œæ…¢ â†’ é™è‡³ 10 FPS
                    frameInterval = 100;
                    jpegQuality = 0.45;
                    console.log('ğŸŸ  [Auto-Throttle] Network slow â†’ 10 FPS, Quality 0.45');
                } else if (skipRate > 40) {
                    // ç½‘ç»œä¸­ç­‰ â†’ 15 FPS
                    frameInterval = 67;
                    jpegQuality = 0.5;
                    console.log('ğŸŸ¡ [Auto-Throttle] Network medium â†’ 15 FPS, Quality 0.5');
                } else if (skipRate < 25) {
                    // ç½‘ç»œå¾ˆå¥½ â†’ 20 FPS
                    frameInterval = 50;
                    jpegQuality = 0.6;
                    console.log('ğŸŸ¢ [Auto-Throttle] Network excellent â†’ 20 FPS, Quality 0.6');
                }
                // 25-40%èŒƒå›´ä¿æŒå½“å‰è®¾ç½®ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢
            });

            socket.on('processed_frame', (data) => {
                // æ˜¾ç¤ºå¤„ç†åçš„å›¾åƒ
                const processedVideo = document.getElementById('processedVideo');
                const processedVideoBox = document.getElementById('processedVideoBox');
                
                processedVideo.src = data.frame;
                
                // ç§»é™¤ç­‰å¾…çŠ¶æ€ï¼ˆéšè—å ä½ç¬¦ï¼‰
                if (processedVideoBox.classList.contains('waiting')) {
                    processedVideoBox.classList.remove('waiting');
                }
                
                // æ›´æ–°å§¿æ€æ•°æ®
                if (data.pose_data) {
                    updatePoseData(data.pose_data);
                }
            });

            socket.on('error', (data) => {
                console.error('é”™è¯¯:', data.message);
                alert('é”™è¯¯: ' + data.message);
            });

            socket.on('stream_started', () => {
                console.log('è§†é¢‘æµå·²å¼€å§‹');
            });

            socket.on('stream_stopped', () => {
                console.log('è§†é¢‘æµå·²åœæ­¢');
            });
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('streamBtn').disabled = false;
                console.log('æ‘„åƒå¤´å·²å¯åŠ¨');
            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message);
            }
        }

        // å¼€å§‹è§†é¢‘æµåˆ†æ
        function startStream() {
            if (isStreaming) return;
            
            isStreaming = true;
            socket.emit('start_stream');
            
            document.getElementById('streamBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            updateStatus('streaming', 'ğŸ¯ æ­£åœ¨åˆ†æå§¿æ€...');

            // æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—å¹¶åˆå§‹åŒ–
            clearLogs();

            // å¼€å§‹å‘é€è§†é¢‘å¸§
            sendFrames();
        }

        // åœæ­¢è§†é¢‘æµåˆ†æ
        function stopStream() {
            isStreaming = false;
            socket.emit('stop_stream');
            
            document.getElementById('streamBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateStatus('connected', 'æœåŠ¡å™¨å·²è¿æ¥');
            
            // ğŸ”¥ ä¼˜åŒ–ï¼šé‡ç½® Canvas æ ‡å¿—
            canvasInitialized = false;
            
            // æ¢å¤ç­‰å¾…çŠ¶æ€
            const processedVideoBox = document.getElementById('processedVideoBox');
            if (!processedVideoBox.classList.contains('waiting')) {
                processedVideoBox.classList.add('waiting');
            }
        }

        // å‘é€è§†é¢‘å¸§åˆ°æœåŠ¡å™¨
        function sendFrames() {
            if (!isStreaming) return;

            const video = document.getElementById('localVideo');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // ğŸ”¥ ä¼˜åŒ–ï¼šæ€§èƒ½ç›‘æ§å¼€å§‹
                const startEncode = performance.now();
                
                // ğŸ”¥ ä¼˜åŒ–ï¼šé™ä½åˆ†è¾¨ç‡åˆ°50%ï¼Œåªè®¾ç½®ä¸€æ¬¡
                if (!canvasInitialized) {
                    canvas.width = Math.floor(video.videoWidth * 0.5);
                    canvas.height = Math.floor(video.videoHeight * 0.5);
                    canvasInitialized = true;
                    console.log(`[Optimize] Canvas size: ${canvas.width}x${canvas.height} (50% of original)`);
                }
                
                // ç»˜åˆ¶è§†é¢‘å¸§åˆ° canvasï¼ˆç¼©æ”¾ï¼‰
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // ğŸ”¥ ä¼˜åŒ–ï¼šä½¿ç”¨è‡ªé€‚åº”JPEGè´¨é‡
                const frameData = canvas.toDataURL('image/jpeg', jpegQuality).split(',')[1];
                
                // ğŸ”¥ æ€§èƒ½ç›‘æ§ï¼šè®°å½•ç¼–ç æ—¶é—´å’Œå¤§å°
                performanceStats.encodeTime = performance.now() - startEncode;
                performanceStats.frameSize = frameData.length;
                
                // æ¯10ç§’æ‰“å°ä¸€æ¬¡æ€§èƒ½ç»Ÿè®¡
                const now = Date.now();
                if (now - performanceStats.lastUpdateTime > 10000) {
                    console.log(`[Performance] Encode: ${performanceStats.encodeTime.toFixed(1)}ms | Size: ${(performanceStats.frameSize / 1024).toFixed(1)}KB | Quality: ${jpegQuality}`);
                    performanceStats.lastUpdateTime = now;
                }
                
                // å‘é€åˆ°æœåŠ¡å™¨
                socket.emit('video_frame', { frame: frameData });
            }

            // ğŸ”¥ é«˜æ€§èƒ½æ¨¡å¼ï¼šè‡ªé€‚åº”å¸§ç‡ï¼ˆ5-20 FPSæ ¹æ®ç½‘ç»œè‡ªåŠ¨è°ƒæ•´ï¼‰
            // æ³¨æ„ï¼šæ—¥å¿—è®°å½•é¢‘ç‡ç”±æœåŠ¡å™¨ç«¯çš„ record_interval é…ç½®æ§åˆ¶
            setTimeout(() => {
                if (isStreaming) {
                    sendFrames();
                }
            }, frameInterval);  // è‡ªé€‚åº”é—´éš”ï¼š50ms(20FPS) - 200ms(5FPS)
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, text) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        // æ›´æ–°å§¿æ€æ•°æ®æ˜¾ç¤º
        function updatePoseData(poseData) {
            // åªæ›´æ–°æ‰“å°å°é£æ ¼æ—¥å¿—ï¼ˆå§¿æ€æ•°æ®å¡ç‰‡å·²ç§»é™¤ï¼‰
            addLogRecord(poseData);
        }

        // æ·»åŠ æ‰“å°å°é£æ ¼æ—¥å¿—è®°å½•ï¼ˆä»ä¸‹å¾€ä¸Šåˆ·æ–°ï¼‰
        function addLogRecord(poseData) {
            logRecordCount++;
            
            const time = poseData.datetime || new Date().toISOString().replace('T', ' ').substring(0, 23);
            const pose = (poseData.pose || 'Unknown').toUpperCase();
            const hasTarget = poseData.has_target !== false;
            const confidence = poseData.confidence || 0.0;
            const points = poseData.landmarks_count || 0;

            // ç”ŸæˆçŠ¶æ€æ ‡è®°
            let statusHtml, poseDisplay;
            if (!hasTarget || pose === 'NO TARGET') {
                statusHtml = '<span class="log-status-notarget">[NO TARGET]</span>';
                poseDisplay = 'No Target';
            } else {
                statusHtml = '<span class="log-status-detect">[ DETECT ]</span>';
                poseDisplay = pose.padEnd(12, ' ');
            }

            // æ ¼å¼åŒ–è®°å½•è¡Œ
            const logLine = `<span class="log-number">#${String(logRecordCount).padStart(5, '0')}</span> | ` +
                          `<span class="log-time">${time}</span> | ` +
                          `${statusHtml} | ` +
                          `Pose: <span class="log-pose">${poseDisplay}</span> | ` +
                          `Conf: <span class="log-conf">${confidence.toFixed(2)}</span> | ` +
                          `Points: <span class="log-points">${String(points).padStart(2, ' ')}</span>`;

            const logOutput = document.getElementById('logOutput');
            const logLineDiv = document.createElement('div');
            logLineDiv.className = 'log-line';
            logLineDiv.innerHTML = logLine;
            
            // æ‰¾åˆ°æ ‡é¢˜è¡Œåçš„ç¬¬ä¸€ä¸ªä½ç½®ï¼ˆè·³è¿‡3ä¸ªheaderï¼‰
            const headerCount = 3;
            const firstContentIndex = headerCount;
            
            // åœ¨æ ‡é¢˜åæ’å…¥æ–°è®°å½•ï¼ˆæœ€æ–°è®°å½•åœ¨æœ€ä¸Šé¢ï¼‰
            if (logOutput.children.length > headerCount) {
                logOutput.insertBefore(logLineDiv, logOutput.children[firstContentIndex]);
            } else {
                logOutput.appendChild(logLineDiv);
            }

            // æ¯50æ¡è®°å½•æ·»åŠ åˆ†éš”çº¿
            if (logRecordCount % 50 === 0) {
                const separator = document.createElement('div');
                separator.className = 'log-line separator';
                separator.textContent = 'â”€'.repeat(60);
                if (logOutput.children.length > headerCount) {
                    logOutput.insertBefore(separator, logOutput.children[firstContentIndex]);
                } else {
                    logOutput.appendChild(separator);
                }
            }

            // é™åˆ¶æœ€å¤§è¡Œæ•°ï¼ˆåˆ é™¤æœ€åº•éƒ¨çš„æ—§è®°å½•ï¼‰
            while (logOutput.children.length > maxLogLines + headerCount) {
                logOutput.removeChild(logOutput.lastChild);
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼ˆæ˜¾ç¤ºæœ€æ–°è®°å½•ï¼‰
            if (autoScroll) {
                logOutput.scrollTop = 0;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = `
                <div class="log-line header">
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </div>
                <div class="log-line header">
                    ğŸ“Š REAL-TIME LOG (Latest on Top â¬†ï¸ | Scroll Down for History â¬‡ï¸)
                </div>
                <div class="log-line header">
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                </div>
            `;
            logRecordCount = 0;
        }

        // åˆ‡æ¢æ ¼å¼è¯´æ˜æ˜¾ç¤º
        function toggleFormatGuide() {
            const guide = document.getElementById('formatGuide');
            guide.classList.toggle('active');
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const text = document.getElementById('autoScrollText');
            text.textContent = autoScroll ? 'ğŸ” ç½®é¡¶' : 'â¸ï¸ æš‚åœ';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            initSocket();
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (socket) {
                socket.disconnect();
            }
        };
    </script>
</body>
</html>

